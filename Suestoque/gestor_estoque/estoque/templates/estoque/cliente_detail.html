{% extends 'estoque/base.html' %}
{% load l10n %}

{% block title %}Análise de {{ cliente.nome }}{% endblock %}

{% block content %}
<!-- CABEÇALHO DA PÁGINA -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-0">Análise de Cliente: <span class="text-primary">{{ cliente.nome }}</span></h1>
        <p class="text-secondary">Informações de contato e histórico de compras.</p>
    </div>
    <a href="{% url 'cliente_list' %}" class="btn btn-dark">
        <i class="bi bi-arrow-left"></i> Voltar para a Lista
    </a>
</div>

<!-- SEÇÃO 1: KPIs DO CLIENTE -->
<h2 class="h5 section-title">Métricas de Valor</h2>
<div class="row g-4 mb-5">
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body text-center">
                <h3 class="card-title display-6 fw-bold text-success">R$ {{ total_gasto|floatformat:2 }}</h3>
                <p class="card-text text-secondary">Total Gasto (Lifetime)</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body text-center">
                <h3 class="card-title display-6 fw-bold text-info">R$ {{ total_lucro|floatformat:2 }}</h3>
                <p class="card-text text-secondary">Lucro Gerado</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body text-center">
                <h3 class="card-title display-6 fw-bold">R$ {{ ticket_medio|floatformat:2 }}</h3>
                <p class="card-text text-secondary">Gasto Médio por Compra</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-body text-center">
                <h3 class="card-title display-6 fw-bold">
                    {% if frequencia_dias %}
                        ~{{ frequencia_dias|floatformat:0 }}
                    {% else %}
                        -
                    {% endif %}
                </h3>
                <p class="card-text text-secondary">Frequência (dias)</p>
            </div>
        </div>
    </div>
</div>

<!-- SEÇÃO 2: PRODUTOS FAVORITOS E HISTÓRICO -->
<div class="row g-4">
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header fw-bold"><i class="bi bi-star-fill text-warning"></i> Produtos Favoritos</div>
            <ul class="list-group list-group-flush">
                {% for item in produtos_favoritos %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <small>{{ item.nome_completo }}</small>
                    <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">{{ item.qtd_comprada }} un.</span>
                </li>
                {% empty %}
                <li class="list-group-item text-secondary text-center">Sem dados de produtos.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header fw-bold"><i class="bi bi-receipt"></i> Histórico de Compras ({{ num_compras }})</div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Data</th>
                            <th scope="col">Variação do Produto</th>
                            <th scope="col" class="text-center">Qtd.</th>
                            <th scope="col" class="text-end">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for compra in compras %}
                        <tr>
                            <td><small>{{ compra.data|date:"d/m/Y H:i" }}</small></td>
                            <td><small>{{ compra.variacao }}</small></td>
                            <td class="text-center">{{ compra.quantidade }}</td>
                            <td class="text-end">R$ {% widthratio compra.quantidade 1 compra.variacao.preco_de_venda %}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4 text-secondary">Nenhuma compra registrada para este cliente.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
