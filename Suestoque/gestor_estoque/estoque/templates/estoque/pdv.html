{% extends 'estoque/base.html' %}
{% load l10n %}

{% block title %}Frente de Caixa (PDV){% endblock %}

{% block content %}
<!-- CABEÇALHO DA PÁGINA -->
<div class="mb-4">
    <h1 class="h2 mb-0">Frente de Caixa (PDV)</h1>
    <p class="text-secondary">Inicie uma nova venda pesquisando por um produto ou usando o leitor.</p>
</div>

<!-- Alerta para mensagens de sucesso ou erro -->
<div id="pdv-alert-placeholder"></div>

<div class="row g-4">
    <!-- COLUNA ESQUERDA: BUSCA E CARRINHO -->
    <div class="col-lg-7">
        <div class="card shadow-sm mb-4">
            <div class="card-body position-relative">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="search-product" placeholder="Pesquisar por nome, cor, tamanho ou código..." autocomplete="off">
                    <!-- BOTÃO DO SCANNER -->
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#scannerModal" title="Ler Código de Barras">
                        <i class="bi bi-upc-scan"></i>
                    </button>
                </div>
                <div id="search-results-container" class="list-group position-absolute w-100 mt-1" style="z-index: 1050; max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header fw-bold">
                <i class="bi bi-cart3"></i> Itens da Venda
            </div>
            <div class="table-responsive">
                <table class="table mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Produto</th>
                            <th scope="col" class="text-center" style="width: 150px;">Qtd.</th>
                            <th scope="col" class="text-end">Subtotal</th>
                            <th scope="col" class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="cart-items">
                        <tr id="empty-cart-row">
                            <td colspan="4" class="text-center py-5 text-secondary">
                                <i class="bi bi-cart-x fs-1"></i>
                                <p class="mt-2 mb-0">O carrinho está vazio.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- COLUNA DIREITA: RESUMO E FINALIZAÇÃO -->
    <div class="col-lg-5">
        <div class="card shadow-sm sticky-top" style="top: 20px;">
            <div class="card-body p-4">
                <h3 class="h5 mb-3">Resumo da Venda</h3>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-secondary">Subtotal</span>
                    <span id="subtotal">R$ 0,00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-secondary">Descontos</span>
                    <span id="descontos" class="text-danger">- R$ 0,00</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <span class="fw-bold fs-5">TOTAL</span>
                    <span id="total" class="fw-bold fs-3 text-primary">R$ 0,00</span>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg" id="finalize-sale-btn" disabled>
                        <i class="bi bi-check-circle-fill"></i> Finalizar Venda
                    </button>
                    <button class="btn btn-outline-danger" id="cancel-sale-btn">
                        <i class="bi bi-x-circle"></i> Cancelar Venda
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA O SCANNER DE CÓDIGO DE BARRAS (AGORA DENTRO DO BLOCK CONTENT) -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="scannerModalLabel">Leitor de Código de Barras</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-center text-secondary">Aponte a câmara para o código de barras do produto.</p>
        <div id="reader" style="width: 100%;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts_extra %}
<!-- Biblioteca do Scanner de Código de Barras -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SELEÇÃO DE ELEMENTOS DO DOM ---
    // Guardamos todos os elementos HTML que vamos manipular em variáveis para fácil acesso.
    const searchInput = document.getElementById('search-product');
    const resultsContainer = document.getElementById('search-results-container');
    const cartItemsContainer = document.getElementById('cart-items');
    const emptyCartRow = document.getElementById('empty-cart-row');
    const subtotalEl = document.getElementById('subtotal');
    const totalEl = document.getElementById('total');
    const finalizeSaleBtn = document.getElementById('finalize-sale-btn');
    const cancelSaleBtn = document.getElementById('cancel-sale-btn');
    const alertPlaceholder = document.getElementById('pdv-alert-placeholder');
    const scannerModal = document.getElementById('scannerModal');

    // --- ESTADO DA APLICAÇÃO ---
    // 'cart' é um objeto que armazena todos os produtos da venda atual.
    let cart = {};
    // 'searchTimeout' é usado para otimizar a busca (debounce).
    let searchTimeout;

    // --- LÓGICA DO SCANNER ---
    // Inicializa a biblioteca do leitor de código de barras.
    const html5QrCode = new Html5Qrcode("reader");

    // Função chamada quando um código de barras é lido com sucesso.
    const onScanSuccess = (decodedText, decodedResult) => {
        html5QrCode.stop().then(() => {
            searchInput.value = decodedText;
            fetchProducts(decodedText, true); // O 'true' indica para adicionar ao carrinho automaticamente.
            bootstrap.Modal.getInstance(scannerModal).hide();
        }).catch(err => console.error("Erro ao parar o scanner:", err));
    };

    // Função chamada quando a leitura falha (ignoramos para não poluir o console).
    const onScanFailure = (error) => {};

    // Inicia o scanner quando o modal é aberto.
    scannerModal.addEventListener('shown.bs.modal', () => {
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, onScanSuccess, onScanFailure)
            .catch(err => console.error(`Não foi possível iniciar o scanner: ${err}`));
    });

    // Para o scanner quando o modal é fechado para economizar bateria/recursos.
    scannerModal.addEventListener('hidden.bs.modal', () => {
        if (html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => {});
        }
    });

    // --- FUNÇÕES DE UTILIDADE ---
    // Formata um número para o padrão de moeda brasileiro (R$).
    const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;

    // Cria e exibe um alerta dinâmico na tela.
    const showAlert = (message, type = 'success') => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert"><div>${message}</div><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        alertPlaceholder.innerHTML = '';
        alertPlaceholder.append(wrapper);
    };

    // --- LÓGICA DO CARRINHO ---
    // Recalcula e atualiza os totais no resumo da venda.
    const updateCartSummary = () => {
        const subtotal = Object.values(cart).reduce((sum, item) => sum + item.subtotal, 0);
        subtotalEl.textContent = formatCurrency(subtotal);
        totalEl.textContent = formatCurrency(subtotal);
        finalizeSaleBtn.disabled = Object.keys(cart).length === 0;
        emptyCartRow.style.display = Object.keys(cart).length === 0 ? 'table-row' : 'none';
    };

    // Adiciona um produto ao carrinho ou incrementa sua quantidade.
    const addToCart = (product) => {
        const { id, name, price, stock } = product;
        if (cart[id]) {
            if (cart[id].quantity < stock) cart[id].quantity++;
            else showAlert(`Estoque máximo para "${name}" atingido.`, 'warning');
        } else {
            if (stock > 0) cart[id] = { id, name, price, stock, quantity: 1 };
            else { showAlert(`"${name}" está sem estoque.`, 'danger'); return; }
        }
        cart[id].subtotal = cart[id].quantity * cart[id].price;
        renderCart();
    };

    // Desenha a tabela de itens do carrinho na tela.
    const renderCart = () => {
        cartItemsContainer.innerHTML = '';
        if (Object.keys(cart).length === 0) {
            cartItemsContainer.appendChild(emptyCartRow);
        } else {
            for (const productId in cart) {
                const item = cart[productId];
                const row = document.createElement('tr');
                row.dataset.productId = item.id;
                row.innerHTML = `<td>${item.name}</td><td class="text-center"><div class="input-group input-group-sm"><button class="btn btn-outline-secondary btn-sm cart-qty-btn" data-action="decrease">-</button><input type="number" class="form-control text-center cart-qty-input" value="${item.quantity}" min="1" max="${item.stock}"><button class="btn btn-outline-secondary btn-sm cart-qty-btn" data-action="increase">+</button></div></td><td class="text-end fw-bold">${formatCurrency(item.subtotal)}</td><td class="text-center"><button class="btn btn-outline-danger btn-sm remove-from-cart-btn"><i class="bi bi-trash"></i></button></td>`;
                cartItemsContainer.appendChild(row);
            }
        }
        updateCartSummary();
    };

    // --- LÓGICA DA BUSCA ---
    // Conversa com a API do Django para buscar produtos.
    const fetchProducts = async (query, autoAddToCart = false) => {
        if (query.length < 2) { resultsContainer.innerHTML = ''; return; }
        try {
            const response = await fetch(`{% url 'pdv_search_variacoes' %}?q=${query}`);
            const data = await response.json();
            if (autoAddToCart && data.length === 1) {
                const p = data[0];
                addToCart({ id: p.id, name: p.nome_completo, price: parseFloat(p.preco_venda), stock: parseInt(p.estoque) });
                searchInput.value = '';
                searchInput.focus();
            } else {
                renderResults(data);
            }
        } catch (error) { console.error('Erro ao buscar produtos:', error); }
    };

    // Desenha a lista de resultados da busca na tela.
    const renderResults = (products) => {
        if (products.length === 0) { resultsContainer.innerHTML = '<span class="list-group-item text-secondary">Nenhuma variação encontrada.</span>'; return; }
        resultsContainer.innerHTML = products.map(p => `<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center add-to-cart-btn" data-product-id="${p.id}" data-product-name="${p.nome_completo}" data-product-price="${p.preco_venda}" data-product-stock="${p.estoque}"><div><strong>${p.nome_completo}</strong><small class="d-block text-secondary">Estoque: ${p.estoque} | R$ ${parseFloat(p.preco_venda).toFixed(2)}</small></div>${p.estoque > 0 ? '<i class="bi bi-plus-circle-fill text-primary fs-4"></i>' : '<span class="badge bg-danger">Sem Estoque</span>'}</a>`).join('');
    };

    // --- EVENT LISTENERS (Onde a Mágica Acontece) ---
    // Ouve a digitação na barra de busca.
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => fetchProducts(searchInput.value), 300);
    });

    // Ouve cliques em qualquer parte da página para ações dinâmicas.
    document.addEventListener('click', (e) => {
        const addToCartBtn = e.target.closest('.add-to-cart-btn');
        if (addToCartBtn) {
            e.preventDefault();
            const pData = { id: addToCartBtn.dataset.productId, name: addToCartBtn.dataset.productName, price: parseFloat(addToCartBtn.dataset.productPrice), stock: parseInt(addToCartBtn.dataset.productStock) };
            addToCart(pData);
            searchInput.value = '';
            resultsContainer.innerHTML = '';
            searchInput.focus();
        }
    });

    // Ouve cliques dentro da tabela do carrinho.
    cartItemsContainer.addEventListener('click', e => {
        const removeBtn = e.target.closest('.remove-from-cart-btn');
        if(removeBtn) {
            const productId = removeBtn.closest('tr').dataset.productId;
            delete cart[productId];
            renderCart();
        }

        const qtyBtn = e.target.closest('.cart-qty-btn');
        if(qtyBtn) {
            const productId = qtyBtn.closest('tr').dataset.productId;
            const action = qtyBtn.dataset.action;
            if (action === 'increase' && cart[productId].quantity < cart[productId].stock) cart[productId].quantity++;
            else if (action === 'decrease' && cart[productId].quantity > 1) cart[productId].quantity--;
            cart[productId].subtotal = cart[productId].quantity * cart[productId].price;
            renderCart();
        }
    });
    
    // Ouve mudanças manuais na quantidade.
    cartItemsContainer.addEventListener('change', e => {
        if(e.target.classList.contains('cart-qty-input')) {
            const productId = e.target.closest('tr').dataset.productId;
            let newQty = parseInt(e.target.value);
            if (isNaN(newQty) || newQty < 1) newQty = 1;
            if (newQty > cart[productId].stock) newQty = cart[productId].stock;
            cart[productId].quantity = newQty;
            cart[productId].subtotal = cart[productId].quantity * cart[productId].price;
            renderCart();
        }
    });

    // Ouve o clique para cancelar a venda.
    cancelSaleBtn.addEventListener('click', () => {
        if (Object.keys(cart).length > 0 && confirm('Tem certeza que deseja cancelar esta venda e limpar o carrinho?')) {
            cart = {};
            renderCart();
        }
    });

    // Ouve o clique para finalizar a venda.
    finalizeSaleBtn.addEventListener('click', async () => {
        if (Object.keys(cart).length === 0) return;

        finalizeSaleBtn.disabled = true;
        finalizeSaleBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Finalizando...';

        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        try {
            const response = await fetch('{% url "pdv_finalizar_venda" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ cart: cart })
            });
            const result = await response.json();
            if (response.ok) {
                showAlert(result.message, 'success');
                cart = {};
                renderCart();
            } else {
                showAlert(result.message, 'danger');
            }
        } catch (error) {
            showAlert('Ocorreu um erro de comunicação com o servidor. Tente novamente.', 'danger');
        } finally {
            finalizeSaleBtn.disabled = false;
            finalizeSaleBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Finalizar Venda';
        }
    });
});
</script>
{% endblock %}

