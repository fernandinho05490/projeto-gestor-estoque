{% extends 'estoque/base.html' %}

{% block title %}Análises Detalhadas{% endblock %}

{% block head_extra %}
<style>
    /* ===== SISTEMA DE DESIGN PREMIUM ===== */
    :root {
        --glass-bg: rgba(255, 255, 255, 0.08);
        --glass-border: rgba(255, 255, 255, 0.12);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
        --glass-shadow-hover: 0 12px 48px 0 rgba(0, 0, 0, 0.6);
        --transition-speed: 0.4s;
        --card-radius: 20px;
        --element-radius: 12px;
        --gradient-primary: linear-gradient(135deg, var(--bs-primary) 0%, #667eea 100%);
        --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        --gradient-info: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        --gradient-danger: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        --gradient-warning: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    }
    
    [data-bs-theme='light'] {
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(0, 0, 0, 0.08);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.12);
        --glass-shadow-hover: 0 16px 48px 0 rgba(0, 0, 0, 0.18);
    }

    /* ===== ANIMAÇÕES PROFISSIONAIS ===== */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(40px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(1deg); }
    }

    /* ===== LAYOUT PRINCIPAL ===== */
    .analytics-container {
        animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    /* ===== HEADER PREMIUM ===== */
    .analytics-header {
        background: var(--gradient-primary);
        color: white;
        border-radius: var(--card-radius);
        padding: 2.5rem;
        margin-bottom: 2.5rem;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .analytics-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 8s ease-in-out infinite;
    }
    
    .analytics-header::after {
        content: '';
        position: absolute;
        bottom: -40%;
        left: -15%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite reverse;
    }
    
    [data-bs-theme='light'] .analytics-header {
        color: #1a1a1a;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    [data-bs-theme='light'] .analytics-header::before {
        background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 70%);
    }
    
    [data-bs-theme='light'] .analytics-header::after {
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
    }

    /* ===== SISTEMA DE CARDS PREMIUM ===== */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid var(--glass-border);
        border-radius: var(--card-radius);
        box-shadow: var(--glass-shadow);
        transition: all var(--transition-speed) cubic-bezier(0.25, 0.46, 0.45, 0.94);
        overflow: hidden;
        position: relative;
    }
    
    .glass-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    }
    
    .glass-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--glass-shadow-hover);
        border-color: rgba(var(--bs-primary-rgb), 0.3);
    }

    /* ===== MÉTRICAS ULTRA PREMIUM ===== */
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }
    
    .metric-card {
        padding: 2rem 1.5rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--gradient-primary);
        transform: scaleX(0);
        transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .metric-card:hover::after {
        transform: scaleX(1);
    }
    
    .metric-icon-wrapper {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(var(--bs-primary-rgb), 0.1) 0%, rgba(var(--bs-primary-rgb), 0.05) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        position: relative;
        transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .metric-icon-wrapper::before {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: 50%;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.5s ease;
    }
    
    .metric-card:hover .metric-icon-wrapper {
        transform: scale(1.1) rotate(5deg);
        background: var(--gradient-primary);
    }
    
    .metric-card:hover .metric-icon-wrapper::before {
        opacity: 1;
    }
    
    .metric-icon {
        font-size: 2rem;
        color: var(--bs-primary);
        position: relative;
        z-index: 2;
        transition: all 0.5s ease;
    }
    
    .metric-card:hover .metric-icon {
        color: white;
        transform: scale(1.1);
    }
    
    .metric-value {
        font-size: 2.2rem;
        font-weight: 800;
        margin: 0.5rem 0;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1.1;
        position: relative;
    }
    
    .metric-value::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 2px;
        background: var(--gradient-primary);
        transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .metric-card:hover .metric-value::after {
        width: 80px;
    }
    
    .metric-label {
        color: var(--bs-secondary-color);
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 0;
        letter-spacing: 0.5px;
    }

    /* ===== CARD DE ALERTA ESPECIAL ===== */
    .alert-metric-card {
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }
    
    .alert-metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(220, 53, 69, 0.15), transparent);
        transition: left 0.8s ease;
    }
    
    .alert-metric-card:hover::before {
        left: 100%;
    }
    
    .alert-metric-card .metric-icon-wrapper {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.15) 0%, rgba(220, 53, 69, 0.08) 100%);
    }
    
    .alert-metric-card .metric-icon {
        color: #dc3545;
    }
    
    .alert-metric-card .metric-value {
        background: var(--gradient-danger);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .alert-metric-card:hover .metric-icon-wrapper {
        background: var(--gradient-danger);
    }

    /* ===== SISTEMA DE GRÁFICOS CORRIGIDO ===== */
    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }
    
    /* CORREÇÃO CRÍTICA: Container do gráfico com altura fixa */
    .chart-card {
        display: flex;
        flex-direction: column;
        height: 400px; /* Altura fixa para todos os cards de gráfico */
    }
    
    .chart-header {
        padding: 1.5rem 1.5rem 1rem;
        border-bottom: 1px solid var(--glass-border);
        background: rgba(var(--bs-body-color-rgb), 0.02);
        flex-shrink: 0; /* Impede que o header seja esmagado */
    }
    
    .chart-title {
        font-weight: 600;
        color: var(--bs-body-color);
        margin: 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .chart-title i {
        font-size: 1.1rem;
    }
    
    /* CORREÇÃO CRÍTICA: Wrapper do gráfico com altura flexível mas controlada */
    .chart-wrapper {
        position: relative;
        flex: 1; /* Ocupa o espaço restante */
        min-height: 0; /* Permite que o flex shrink funcione */
        padding: 1rem 1.5rem 1.5rem;
    }
    
    /* CORREÇÃO CRÍTICA: Canvas com altura 100% do wrapper */
    .chart-canvas {
        width: 100% !important;
        height: 100% !important;
        max-height: 100%;
    }

    /* ===== TÍTULOS DE SEÇÃO PREMIUM ===== */
    .section-title {
        color: var(--bs-body-color);
        font-weight: 700;
        margin-bottom: 1.5rem;
        position: relative;
        padding-bottom: 0.75rem;
        font-size: 1.4rem;
        letter-spacing: -0.5px;
    }
    
    .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 4px;
        background: var(--gradient-primary);
        border-radius: 2px;
        box-shadow: 0 2px 8px rgba(var(--bs-primary-rgb), 0.3);
    }

    /* ===== LINKS PREMIUM ===== */
    .card-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }
    
    .card-link:hover {
        color: inherit;
        text-decoration: none;
    }

    /* ===== RESPONSIVIDADE AVANÇADA ===== */
    @media (max-width: 1200px) {
        .charts-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .charts-grid > *:first-child {
            grid-column: 1 / -1;
        }
        
        .chart-card {
            height: 350px;
        }
    }
    
    @media (max-width: 768px) {
        .analytics-header {
            padding: 2rem 1.5rem;
            text-align: center;
        }
        
        .metric-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .charts-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .chart-card {
            height: 300px;
        }
        
        .metric-card {
            padding: 1.5rem 1rem;
        }
        
        .metric-value {
            font-size: 1.8rem;
        }
        
        .metric-icon-wrapper {
            width: 60px;
            height: 60px;
            margin-bottom: 1rem;
        }
        
        .metric-icon {
            font-size: 1.5rem;
        }
        
        .chart-header {
            padding: 1.25rem 1.25rem 0.75rem;
        }
    }
    
    @media (max-width: 576px) {
        .analytics-container {
            padding: 0 0.5rem;
        }
        
        .analytics-header {
            padding: 1.5rem 1rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            height: 250px;
        }
        
        .chart-wrapper {
            padding: 0.75rem 1rem 1.25rem;
        }
        
        .section-title {
            font-size: 1.2rem;
        }
    }

    /* ===== ANIMAÇÕES DE ENTRADA ESCALONADAS ===== */
    .metric-card {
        animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        opacity: 0;
    }
    
    .metric-card:nth-child(1) { animation-delay: 0.1s; }
    .metric-card:nth-child(2) { animation-delay: 0.2s; }
    .metric-card:nth-child(3) { animation-delay: 0.3s; }
    .metric-card:nth-child(4) { animation-delay: 0.4s; }
    
    .glass-card {
        animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        opacity: 0;
        animation-delay: 0.5s;
    }

    /* ===== ESTADOS ESPECIAIS ===== */
    .glass-card:active {
        transform: translateY(-2px) scale(1.01);
        transition: transform 0.1s ease;
    }
    
    /* Efeito de brilho sutil nos cards */
    .glass-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.8s ease;
    }
    
    .glass-card:hover::after {
        left: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- HEADER ULTRA PREMIUM -->
    <div class="analytics-header">
        <div class="row align-items-center">
            <div class="col-12">
                <h1 class="h2 mb-3 fw-bold">Análises Detalhadas</h1>
                <p class="mb-0 opacity-90 fs-6">
                    Insights profundos e métricas essenciais para decisões estratégicas inteligentes
                </p>
            </div>
        </div>
    </div>

    {% if perms.estoque.change_variacao %}
    <!-- RESUMO GERAL - GRID MODERNO -->
    <section class="mb-5">
        <h2 class="section-title">Resumo Geral</h2>
        <div class="metric-grid">
            <!-- Faturamento -->
            <div class="metric-card glass-card">
                <div class="metric-icon-wrapper">
                    <i class="bi bi-currency-dollar metric-icon"></i>
                </div>
                <div class="metric-value text-success">R$ {{ faturamento_total|floatformat:2 }}</div>
                <div class="metric-label">Faturamento Total</div>
            </div>

            <!-- Lucro -->
            <div class="metric-card glass-card">
                <div class="metric-icon-wrapper">
                    <i class="bi bi-graph-up-arrow metric-icon"></i>
                </div>
                <div class="metric-value text-info">R$ {{ lucro_total|floatformat:2 }}</div>
                <div class="metric-label">Lucro Total</div>
            </div>

            <!-- Inventário -->
            <div class="metric-card glass-card">
                <div class="metric-icon-wrapper">
                    <i class="bi bi-box-seam metric-icon"></i>
                </div>
                <div class="metric-value text-primary">R$ {{ total_inventory_value|floatformat:2 }}</div>
                <div class="metric-label">Valor do Inventário</div>
            </div>

            <!-- Alertas -->
            <a href="?filtro=perigo" class="card-link">
                <div class="metric-card glass-card alert-metric-card">
                    <div class="metric-icon-wrapper">
                        <i class="bi bi-exclamation-triangle metric-icon"></i>
                    </div>
                    <div class="metric-value text-danger">{{ produtos_perigo_count }} / {{ total_produtos }}</div>
                    <div class="metric-label">Variações em Alerta</div>
                </div>
            </a>
        </div>
    </section>
    {% endif %}

    <!-- ANÁLISE VISUAL - LAYOUT AVANÇADO -->
    <section class="mb-5">
        <h2 class="section-title">Análise Visual</h2>
        <div class="charts-grid">
            <!-- Gráfico Principal -->
            <div class="glass-card chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="bi bi-bar-chart-line-fill text-primary"></i>
                        Top 5 Produtos Mais Vendidos
                    </h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartMaisVendidas" class="chart-canvas" 
                            data-labels="{{ chart_mais_vendidos_labels }}" 
                            data-values="{{ chart_mais_vendidos_data }}"></canvas>
                </div>
            </div>

            <!-- Doughnut 1 -->
            <div class="glass-card chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="bi bi-pie-chart-fill text-success"></i>
                        Valor por Categoria
                    </h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartValorCategoria" class="chart-canvas"
                            data-labels="{{ chart_valor_categoria_labels }}" 
                            data-values="{{ chart_valor_categoria_data }}"></canvas>
                </div>
            </div>

            <!-- Doughnut 2 -->
            <div class="glass-card chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="bi bi-pie-chart-fill text-info"></i>
                        Status do Estoque
                    </h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartStatusEstoque" class="chart-canvas"
                            data-labels="{{ chart_status_labels }}" 
                            data-values="{{ chart_status_data }}"></canvas>
                </div>
            </div>
        </div>
    </section>

    {% if perms.estoque.change_variacao %}
        {% include 'estoque/partials/rankings_lucratividade.html' %}
    {% endif %}
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let chartMaisVendidas, chartValorCategoria, chartStatusEstoque;
        
        // Sistema de tema avançado para gráficos
        const updateChartTheme = () => {
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            const fontColor = isDarkMode ? '#adb5bd' : '#495057';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
            const bgColor = isDarkMode ? 'rgba(255, 255, 255, 0.02)' : 'rgba(0, 0, 0, 0.02)';
            
            Chart.defaults.color = fontColor;
            Chart.defaults.backgroundColor = bgColor;
            
            // Atualizar todos os gráficos
            [chartMaisVendidas, chartValorCategoria, chartStatusEstoque].forEach(chart => {
                if (chart) {
                    chart.options.scales = {
                        ...chart.options.scales,
                        x: { 
                            ...chart.options.scales?.x, 
                            grid: { color: gridColor }, 
                            ticks: { color: fontColor } 
                        },
                        y: { 
                            ...chart.options.scales?.y, 
                            grid: { color: gridColor }, 
                            ticks: { color: fontColor } 
                        }
                    };
                    chart.update('none');
                }
            });
        };
        
        // Inicialização premium dos gráficos
        const initCharts = () => {
            // Gráfico de barras horizontal
            const ctxMaisVendidas = document.getElementById('chartMaisVendidas');
            if (ctxMaisVendidas) {
                const labels = JSON.parse(ctxMaisVendidas.dataset.labels);
                const values = JSON.parse(ctxMaisVendidas.dataset.values);
                
                chartMaisVendidas = new Chart(ctxMaisVendidas, {
                    type: 'bar',
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: 'Unidades Vendidas', 
                            data: values, 
                            backgroundColor: 'rgba(0, 122, 255, 0.8)',
                            borderColor: 'rgba(0, 122, 255, 1)',
                            borderWidth: 0,
                            borderRadius: 8,
                            borderSkipped: false,
                        }] 
                    },
                    options: { 
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false, // CRÍTICO: Chart.js controla o aspect ratio
                        scales: {
                            x: { 
                                beginAtZero: true,
                                grid: { display: true },
                                ticks: { precision: 0 }
                            },
                            y: {
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                cornerRadius: 8
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }
            
            // Gráfico de doughnut
            const ctxValorCategoria = document.getElementById('chartValorCategoria');
            if(ctxValorCategoria) {
                const labels = JSON.parse(ctxValorCategoria.dataset.labels);
                const values = JSON.parse(ctxValorCategoria.dataset.values);
                
                chartValorCategoria = new Chart(ctxValorCategoria, {
                    type: 'doughnut',
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: 'Valor em R$', 
                            data: values, 
                            backgroundColor: [
                                'rgba(0, 122, 255, 0.8)',
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(111, 66, 193, 0.8)'
                            ],
                            borderWidth: 0,
                            hoverOffset: 15
                        }] 
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // CRÍTICO: Chart.js controla o aspect ratio
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
            }
            
            // Gráfico de pizza
            const ctxStatusEstoque = document.getElementById('chartStatusEstoque');
            if (ctxStatusEstoque) {
                const labels = JSON.parse(ctxStatusEstoque.dataset.labels);
                const values = JSON.parse(ctxStatusEstoque.dataset.values);
                
                chartStatusEstoque = new Chart(ctxStatusEstoque, {
                    type: 'pie',
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: 'Nº de Itens', 
                            data: values, 
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)'
                            ],
                            borderWidth: 0,
                            hoverOffset: 15
                        }] 
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // CRÍTICO: Chart.js controla o aspect ratio
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
            }
            
            updateChartTheme();
        };
        
        // Inicializar e observar mudanças de tema
        initCharts();
        
        const themeObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-bs-theme') {
                    setTimeout(updateChartTheme, 100);
                }
            });
        });
        themeObserver.observe(document.documentElement, { attributes: true });
    });
</script>
{% endblock %}