{% extends 'estoque/base.html' %}
{% load l10n %}

{% block title %}Gestão de Compras Preditiva{% endblock %}

{% block content %}
<!-- CABEÇALHO DA PÁGINA -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-0">Gestão de Compras Preditiva</h1>
        <p class="text-secondary">Selecione os itens e ajuste as quantidades para gerar seus pedidos.</p>
    </div>
    <a href="{% url 'ordem_compra_list' %}" class="btn btn-dark">
        <i class="bi bi-card-list"></i> Ver Ordens de Compra
    </a>
</div>

<!-- FORMULÁRIO ENVOLVENDO A TABELA -->
<form action="{% url 'gerar_ordem_de_compra' %}" method="post">
    {% csrf_token %}
    <div class="card shadow-sm">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-robot text-primary"></i> Lista de Reposição Inteligente
            </span>
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-send-plus-fill"></i> Gerar Ordens para Itens Selecionados
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" class="text-center" style="width: 50px;">
                            <input class="form-check-input" type="checkbox" id="selectAll" title="Selecionar Todos">
                        </th>
                        <th scope="col">Variação do Produto</th>
                        <th scope="col" class="text-center">Est. Atual / Ponto Pedido <i class="bi bi-info-circle-fill text-secondary" data-bs-toggle="tooltip" title="Alerta é acionado quando o Estoque Atual é menor ou igual ao Ponto de Pedido."></i></th>
                        <th scope="col" class="text-center">Média Vendas/Dia</th>
                        <th scope="col" class="text-center">Estoque Restante</th>
                        <th scope="col" class="text-center">Qtd. a Comprar</th>
                        <th scope="col" class="text-end">Custo Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for variacao in variacoes_para_repor %}
                    <tr class="item-row">
                        <td class="text-center">
                            <input class="form-check-input item-checkbox" type="checkbox" name="variacao_id" value="{{ variacao.id }}">
                        </td>
                        <td>
                            <div>{{ variacao }}</div>
                            <small class="text-secondary">{{ variacao.produto.fornecedor.nome|default:"-" }}</small>
                        </td>
                        <td class="text-center">
                            <span class="fw-bold text-danger">{{ variacao.quantidade_em_estoque }}</span> / {{ variacao.ponto_de_pedido }}
                        </td>
                        <td class="text-center">{{ variacao.media_vendas_diaria|unlocalize }}</td>
                        <td class="text-center">
                            {% if variacao.dias_de_estoque_restante == inf %}
                                <i class="bi bi-infinity text-secondary" title="Sem histórico de vendas"></i>
                            {% else %}
                                ~{{ variacao.dias_de_estoque_restante }} dias
                            {% endif %}
                        </td>
                        <td class="text-center" style="min-width: 100px;">
                            <input type="number" class="form-control form-control-sm item-quantidade mx-auto" 
                                   name="quantidade_{{ variacao.id }}" 
                                   value="{{ variacao.quantidade_a_comprar }}" 
                                   min="1"
                                   style="width: 80px;">
                        </td>
                        <td class="text-end fw-bold item-subtotal" data-custo="{{ variacao.preco_de_custo|unlocalize }}">
                            R$ 0,00
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5 text-secondary">
                            <i class="bi bi-check-circle-fill fs-1 text-success"></i>
                            <p class="mt-2 mb-0">Nenhum item precisa de reposição no momento. <br> O sistema está a monitorizar as suas vendas.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if variacoes_para_repor %}
                <tfoot class="table-light">
                    <tr>
                        <td colspan="6" class="text-end fw-bold">Custo Total dos Itens Selecionados:</td>
                        <td id="custo-total-pedido" class="text-end fw-bold fs-5 text-primary">R$ 0,00</td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</form>
{% endblock %}


{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializa os tooltips do Bootstrap para os ícones de informação
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        // Lógica dos checkboxes e cálculo de totais
        const selectAllCheckbox = document.getElementById('selectAll');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const quantidadeInputs = document.querySelectorAll('.item-quantidade');
        const totalCostElement = document.getElementById('custo-total-pedido');

        const formatCurrency = (value) => {
            return `R$ ${value.toFixed(2).replace('.', ',')}`;
        };

        const updateTotals = () => {
            let totalCost = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const checkbox = row.querySelector('.item-checkbox');
                const quantidadeInput = row.querySelector('.item-quantidade');
                const subtotalCell = row.querySelector('.item-subtotal');
                
                const quantidade = parseInt(quantidadeInput.value) || 0;
                const custoUnitario = parseFloat(subtotalCell.dataset.custo) || 0;
                const subtotal = quantidade * custoUnitario;

                subtotalCell.textContent = formatCurrency(subtotal);

                if (checkbox.checked) {
                    totalCost += subtotal;
                }
            });

            if (totalCostElement) {
                totalCostElement.textContent = formatCurrency(totalCost);
            }
        };

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', (event) => {
                itemCheckboxes.forEach(checkbox => {
                    checkbox.checked = event.target.checked;
                });
                updateTotals();
            });
        }

        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateTotals);
        });

        quantidadeInputs.forEach(input => {
            input.addEventListener('input', updateTotals); 
        });

        // Calcula os totais iniciais assim que a página carrega
        updateTotals();
    });
</script>
{% endblock %}

